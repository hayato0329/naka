<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¤ éŸ³å£°èªè­˜ã‚¢ãƒ—ãƒªï¼ˆå­¦ç¿’æ©Ÿèƒ½ä»˜ãï¼‰</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 800px;
            margin: 0 auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        
        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        /* æŠ˜ã‚ŠãŸãŸã¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        .collapsible-section {
            margin-bottom: 20px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .collapsible-header {
            padding: 15px 20px;
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.2s ease;
        }

        .collapsible-header:hover {
            filter: brightness(95%);
        }

        .collapsible-arrow {
            font-size: 14px;
            transition: transform 0.2s ease;
        }

        .collapsible-content {
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .collapsible-content.collapsed {
            max-height: 0;
        }

        .collapsible-content.expanded {
            max-height: 1000px; /* ååˆ†ãªé«˜ã•ã«è¨­å®š */
        }

        .collapsible-inner {
            padding: 20px;
        }

        /* å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³å€‹åˆ¥ã‚«ãƒ©ãƒ¼ */
        .debug-section .collapsible-header {
            background: #212529;
            color: #28a745;
        }

        .debug-section .collapsible-inner {
            background: #212529;
        }

        .status-section .collapsible-header {
            background: #f8f9fa;
            color: #007bff;
            border-left: 4px solid #007bff;
        }

        .status-section .collapsible-inner {
            background: #f8f9fa;
        }

        .api-section .collapsible-header {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }

        .api-section .collapsible-inner {
            background: #fff3cd;
        }

        .template-section .collapsible-header {
            background: #e6f3ff;
            color: #0056b3;
            border-left: 4px solid #0056b3;
        }

        .template-section .collapsible-inner {
            background: #e6f3ff;
        }

        .prompt-section .collapsible-header {
            background: #e8f5e8;
            color: #1e7e34;
            border-left: 4px solid #28a745;
        }

        .prompt-section .collapsible-inner {
            background: #e8f5e8;
        }

        .learning-section .collapsible-header {
            background: #f0e6ff;
            color: #6f42c1;
            border-left: 4px solid #6f42c1;
        }

        .learning-section .collapsible-inner {
            background: #f0e6ff;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 5px 0;
        }
        
        .status-value {
            font-weight: bold;
            padding: 3px 10px;
            border-radius: 15px;
            background: #e9ecef;
            color: #495057;
        }
        
        .status-value.success {
            background: #d4edda;
            color: #155724;
        }
        
        .status-value.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã®æ–°ã—ã„é…ç½® */
        .main-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .btn {
            padding: 15px 20px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            color: white;
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-primary { background: #007bff; }
        .btn-danger { background: #dc3545; }
        .btn-success { background: #28a745; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-info { background: #17a2b8; }
        .btn-secondary { background: #6c757d; }
        .btn-purple { background: #6f42c1; }

        /* ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç·¨é›†ç”¨ã®ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ */
        .prompt-textarea {
            width: 100%;
            min-height: 200px;
            padding: 10px;
            border: 2px solid #ccc;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            resize: both;
            box-sizing: border-box;
            margin-bottom: 15px;
        }

        .prompt-textarea:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
            outline: none;
        }

        /* ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .template-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .template-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .template-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 10px;
            box-sizing: border-box;
        }

        .template-input:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.1);
        }

        .file-input {
            margin-bottom: 10px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 6px;
            background: white;
            width: 100%;
            box-sizing: border-box;
        }

        /* éŸ³å£°èªè­˜çµæœã‚¨ãƒªã‚¢ */
        .transcript-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .transcript-main {
            flex: 1;
        }
        
        .transcript-area {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 20px;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            position: relative;
            user-select: text;
        }
        
        .transcript-area.listening {
            border-color: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
        }
        
        .transcript-area.empty {
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-style: italic;
            font-family: Arial, sans-serif;
        }

        .transcript-textarea {
            width: 100%;
            min-height: 200px;
            max-height: 400px;
            padding: 20px;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            resize: vertical;
            box-sizing: border-box;
        }

        .transcript-textarea.listening {
            border-color: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
        }

        .debug-log {
            color: #28a745;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 150px;
            overflow-y: auto;
            line-height: 1.4;
        }

        /* çµ±è¨ˆæƒ…å ± */
        .stats-section {
            background: #fff3cd;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #ffc107;
        }

        .stats-section h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        /* ç·¨é›†ãƒœã‚¿ãƒ³ */
        .edit-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .edit-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .edit-btn.toggle {
            background: #17a2b8;
            color: white;
        }

        .edit-btn.toggle:hover {
            background: #138496;
        }

        /* å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ç®¡ç† */
        .learning-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .learning-stats {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #6f42c1;
        }

        .learning-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .learning-item .correction-text {
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .learning-item .original {
            color: #dc3545;
        }

        .learning-item .corrected {
            color: #28a745;
        }

        .learning-item .actions {
            display: flex;
            gap: 5px;
        }

        .learning-item .btn-small {
            padding: 3px 8px;
            font-size: 11px;
            border-radius: 3px;
        }

        .correction-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .correction-input-group input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
        }

        .auto-correction-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .auto-correction-toggle input[type="checkbox"] {
            transform: scale(1.2);
        }

        /* èªè¨¼ç”»é¢ */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 20000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .auth-modal {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
        }

        .auth-title {
            color: #333;
            font-size: 24px;
            margin-bottom: 20px;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .auth-input {
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 16px;
            outline: none;
        }

        .auth-input:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
            outline: none;
        }

        .auth-btn {
            padding: 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .auth-btn:hover {
            background: #0056b3;
        }

        .auth-error {
            color: #dc3545;
            font-size: 14px;
            margin-top: 10px;
        }

        .main-content {
            display: none;
        }

        .main-content.authenticated {
            display: block;
        }

        /* é€šçŸ¥ */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            z-index: 10001;
            font-size: 12px;
            max-width: 300px;
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* è¦ç´„ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆè¿½åŠ æ©Ÿèƒ½1ï¼šé …ç›®åˆ¥ã‚³ãƒ”ãƒ¼å¯¾å¿œï¼‰ */
        .summary-popup {
            position: fixed;
            top: 50px;
            right: 50px;
            width: 450px;
            max-height: 680px; /* 600pxã‹ã‚‰å¤‰æ›´ */
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 10000;
            display: none;
            overflow: hidden;
        }

        .summary-header {
            background: #007bff;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .summary-title {
            font-weight: bold;
            font-size: 16px;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .summary-content {
            padding: 20px;
            max-height: 530px; /* 450pxã‹ã‚‰å¤‰æ›´ */
            overflow-y: auto;
            line-height: 1.6;
        }

        .summary-content h2 {
            color: #007bff;
            font-size: 18px;
            margin: 15px 0 10px 0;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
            cursor: pointer;
        }

        .summary-content h2:hover {
            background: rgba(0, 123, 255, 0.1);
            padding: 5px;
            border-radius: 5px;
        }

        .summary-content h3 {
            color: #28a745;
            font-size: 16px;
            margin: 10px 0 5px 0;
            cursor: pointer;
        }

        .summary-content h3:hover {
            background: rgba(40, 167, 69, 0.1);
            padding: 3px;
            border-radius: 3px;
        }

        .summary-section {
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            margin: 5px 0;
        }

        .summary-section:hover {
            background: rgba(0, 123, 255, 0.05);
        }

        .summary-actions {
            padding: 15px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
        }

        .summary-btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }

        .summary-btn.copy {
            background: #28a745;
            color: white;
        }

        .summary-btn.print {
            background: #6c757d;
            color: white;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media (max-width: 768px) {
            .transcript-container {
                flex-direction: column;
            }
            
            .summary-popup {
                top: 20px;
                right: 20px;
                left: 20px;
                width: auto;
                max-height: 70vh;
            }
        }
    </style>
</head>
<body>
    <!-- èªè¨¼ç”»é¢ -->
    <div class="auth-overlay" id="authOverlay">
        <div class="auth-modal">
            <h2 class="auth-title">ğŸ” éŸ³å£°èªè­˜ã‚¢ãƒ—ãƒª</h2>
            <p>ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã«ã¯èªè¨¼ãŒå¿…è¦ã§ã™</p>
            <form class="auth-form" id="authForm">
                <input type="text" class="auth-input" id="username" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼å" required>
                <input type="password" class="auth-input" id="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" required>
                <button type="submit" class="auth-btn">ğŸ”“ ãƒ­ã‚°ã‚¤ãƒ³</button>
            </form>
            <div class="auth-error" id="authError" style="display: none;"></div>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div class="main-content" id="mainContent">
    <div class="container">
        <div class="header">
            <h1>ğŸ¤ éŸ³å£°èªè­˜ã‚¢ãƒ—ãƒªï¼ˆå­¦ç¿’æ©Ÿèƒ½ä»˜ãï¼‰</h1>
            <p>è©¦é¨“æ¥­ç•Œã‚µãƒãƒ¼ãƒˆå¯¾å¿œè¨˜éŒ²ã‚·ã‚¹ãƒ†ãƒ ï¼š<strong style="color:red;">ãƒ’ã‚¢ãƒªãƒ³ã‚°æƒ…å ±ã¯èª¤èªé˜²æ­¢ã®ãŸã‚å¿…ãšå¾©å”±ï¼ï¼</strong></p>
            <p>â˜…å¾©å”±å¿…é ˆæƒ…å ±ï¼š<strong style="color:red;">ã€ãŠé›»è©±å£ã®ç«‹å ´ã€è©¦é¨“åï¼ˆç´šã¾ã§å¾©å”±ï¼‰ã€å•åˆã›è¦ä»¶ã€æ°åç”Ÿå¹´æœˆæ—¥ã€‘</strong>â˜…</p>
            <p>æ³¨æ„ï¼š<strong style="color:blue;">æ¡ˆå†…ä¸­ã¯ã€æ­£å¼ãªè©¦é¨“åç§°ã‚’ä½¿ã†ã€‚</strong></p>
            <p>è©¦é¨“ãƒ»æ¤œå®šæ¥­ç•Œç‰¹åŒ–å‹å­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ  | ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã¯<a href="https://hayato0329.github.io/study/about5.html" target="_blank"><strong style="color:blue;">ã“ã¡ã‚‰</strong></a>ã‚’ã‚¯ãƒªãƒƒã‚¯</p>
        </div>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã®æ–°ã—ã„é…ç½® -->
        <div class="main-controls">
            <button class="btn btn-primary" id="startBtn">ğŸ™ï¸ éŒ²éŸ³é–‹å§‹</button>
            <button class="btn btn-danger" id="stopBtn" disabled>â¹ï¸ éŒ²éŸ³åœæ­¢</button>
            <button class="btn btn-success" id="summaryBtn" disabled>ğŸ¤– å¯¾å¿œè¨˜éŒ²è¦ç´„</button>
            <button class="btn btn-secondary" id="endBtn" disabled>ğŸ”š çµ‚äº†</button>
        </div>

        <!-- éŸ³å£°èªè­˜çµæœã‚¨ãƒªã‚¢ã®ä¸Šã®ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ -->
        <div class="edit-controls">
            <button class="edit-btn toggle" id="editToggleBtn" onclick="toggleEditMode()">âœï¸ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰</button>
        </div>

        <!-- éŸ³å£°èªè­˜çµæœ -->
        <div class="transcript-container">
            <div class="transcript-main">
                <div class="transcript-area empty" id="transcriptArea" style="display: block;">
                    éŸ³å£°èªè­˜çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...
                </div>
                
                <textarea class="transcript-textarea" id="transcriptTextarea" placeholder="éŸ³å£°èªè­˜çµæœã‚’ç·¨é›†ã§ãã¾ã™..." style="display: none;"></textarea>
            </div>
        </div>

        <!-- ãã®ä»–ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ -->
        <div class="controls">
            <button class="btn btn-success" id="downloadBtn" disabled>ğŸ’¾ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
            <button class="btn btn-warning" id="apiBtn">ğŸ”‘ APIè¨­å®š</button>
            <button class="btn btn-primary" id="testBtn" disabled>ğŸ”§ æ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
            <button class="btn btn-purple" id="quickLearnBtn" disabled>ğŸ§  ã‚¯ã‚¤ãƒƒã‚¯å­¦ç¿’</button>
        </div>

        <!-- ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚° -->
        <div class="collapsible-section debug-section">
            <div class="collapsible-header" onclick="toggleSection('debugSection')">
                <span>ğŸ’» ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°</span>
                <span class="collapsible-arrow" id="debugArrow">â–¼</span>
            </div>
            <div class="collapsible-content collapsed" id="debugContent">
                <div class="collapsible-inner">
                    <div class="debug-log" id="debugLog">
                        ã‚¢ãƒ—ãƒªåˆæœŸåŒ–ä¸­...
                    </div>
                </div>
            </div>
        </div>

        <!-- ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ -->
        <div class="collapsible-section status-section">
            <div class="collapsible-header" onclick="toggleSection('statusSection')">
                <span>ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹</span>
                <span class="collapsible-arrow" id="statusArrow">â–¼</span>
            </div>
            <div class="collapsible-content collapsed" id="statusContent">
                <div class="collapsible-inner">
                    <div class="status-item">
                        <span>HTTPSç’°å¢ƒ:</span>
                        <span class="status-value" id="httpsStatus">ç¢ºèªä¸­</span>
                    </div>
                    <div class="status-item">
                        <span>éŸ³å£°èªè­˜API:</span>
                        <span class="status-value" id="speechStatus">ç¢ºèªä¸­</span>
                    </div>
                    <div class="status-item">
                        <span>ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹:</span>
                        <span class="status-value" id="micStatus">æœªç¢ºèª</span>
                    </div>
                    <div class="status-item">
                        <span>Gemini API:</span>
                        <span class="status-value" id="apiStatus">æœªè¨­å®š</span>
                    </div>
                    <div class="status-item">
                        <span>å­¦ç¿’æ©Ÿèƒ½:</span>
                        <span class="status-value success" id="learningStatus">æº–å‚™å®Œäº†</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gemini APIè¨­å®š -->
        <div class="collapsible-section api-section">
            <div class="collapsible-header" onclick="toggleSection('apiSection')">
                <span>ğŸ”‘ Gemini APIè¨­å®š</span>
                <span class="collapsible-arrow" id="apiArrow">â–¼</span>
            </div>
            <div class="collapsible-content collapsed" id="apiContent">
                <div class="collapsible-inner">
                    <p><strong>å¯¾å¿œè¨˜éŒ²è¦ç´„æ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã«è¨­å®šã—ã¦ãã ã•ã„</strong></p>
                    <p>å–å¾—æ–¹æ³•: <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a> â†’ Create API key</p>
                </div>
            </div>
        </div>

        <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç† -->
        <div class="collapsible-section template-section">
            <div class="collapsible-header" onclick="toggleSection('templateSection')">
                <span>ğŸ“„ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†</span>
                <span class="collapsible-arrow" id="templateArrow">â–¼</span>
            </div>
            <div class="collapsible-content collapsed" id="templateContent">
                <div class="collapsible-inner">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠ:</label>
                        <select id="templateSelect" class="template-input" onchange="onTemplateSelectChange()">
                            <option value="">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠ...</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;" id="templateNameLabel">æ–°è¦ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå:</label>
                        <input type="text" id="newTemplateName" class="template-input" placeholder="ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåã‚’å…¥åŠ›">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå†…å®¹:</label>
                        <textarea id="templateContentTextarea" class="prompt-textarea" placeholder="ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
                    </div>
                    
                    <div class="template-controls">
                        <button class="template-btn btn-success" onclick="saveTemplate()">ğŸ’¾ ä¿å­˜</button>
                        <button class="template-btn btn-danger" onclick="deleteTemplate()">ğŸ—‘ï¸ å‰Šé™¤</button>
                        <button class="template-btn btn-info" onclick="editTemplate()">âœï¸ ç·¨é›†</button>
                        <button class="template-btn btn-warning" onclick="loadTemplate()">ğŸ“‹ èª­è¾¼</button>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆ:</label>
                        <input type="file" id="templateFile" class="file-input" accept=".txt,.doc,.docx" onchange="importTemplate(event)">
                    </div>
                </div>
            </div>
        </div>

        <!-- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®š -->
        <div class="collapsible-section prompt-section">
            <div class="collapsible-header" onclick="toggleSection('promptSection')">
                <span>ğŸ“ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®š</span>
                <span class="collapsible-arrow" id="promptArrow">â–¼</span>
            </div>
            <div class="collapsible-content collapsed" id="promptContent">
                <div class="collapsible-inner">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">ç¾åœ¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ:</label>
                        <select id="promptSelect" style="width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #ccc;">
                            <option value="default">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆè©¦é¨“æ¥­ç•Œç‰¹åŒ–è¦ç´„ï¼‰</option>
                            <option value="support">ã‚«ã‚¹ã‚¿ãƒãƒ¼ã‚µãƒãƒ¼ãƒˆç”¨</option>
                            <option value="custom">ã‚«ã‚¹ã‚¿ãƒ </option>
                        </select>
                    </div>
                    <div id="promptPreview" style="background: #f8f9fa; padding: 10px; border-radius: 5px; font-size: 12px; max-height: 100px; overflow-y: auto; margin-bottom: 10px;">
                        è©¦é¨“æ¥­ç•Œç‰¹åŒ–ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¦ç´„ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™
                    </div>
                    <button class="btn btn-success" style="width: 100%; margin-bottom: 10px;" onclick="editPrompt()">âœï¸ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç·¨é›†</button>
                </div>
            </div>
        </div>

        <!-- ãƒ†ã‚­ã‚¹ãƒˆå­¦ç¿’ãƒ»è‡ªå‹•ä¿®æ­£ -->
        <div class="collapsible-section learning-section">
            <div class="collapsible-header" onclick="toggleSection('learningSection')">
                <span>ğŸ§  ãƒ†ã‚­ã‚¹ãƒˆå­¦ç¿’ãƒ»è‡ªå‹•ä¿®æ­£</span>
                <span class="collapsible-arrow" id="learningArrow">â–¼</span>
            </div>
            <div class="collapsible-content collapsed" id="learningContent">
                <div class="collapsible-inner">
                    <!-- è‡ªå‹•ä¿®æ­£è¨­å®š -->
                    <div class="auto-correction-toggle">
                        <input type="checkbox" id="autoCorrection" checked>
                        <label for="autoCorrection">ğŸ”„ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è‡ªå‹•ä¿®æ­£ã‚’æœ‰åŠ¹ã«ã™ã‚‹</label>
                    </div>

                    <!-- å­¦ç¿’çµ±è¨ˆ -->
                    <div class="learning-stats">
                        <h4>ğŸ“Š å­¦ç¿’ãƒ‡ãƒ¼ã‚¿çµ±è¨ˆ</h4>
                        <div class="status-item">
                            <span>å­¦ç¿’æ¸ˆã¿ä¿®æ­£ãƒ‘ã‚¿ãƒ¼ãƒ³:</span>
                            <span class="status-value" id="learningCount">0ä»¶</span>
                        </div>
                        <div class="status-item">
                            <span>ä»Šå›ã‚»ãƒƒã‚·ãƒ§ãƒ³ã§ã®ä¿®æ­£:</span>
                            <span class="status-value" id="sessionCorrectionCount">0ä»¶</span>
                        </div>
                        <div class="status-item">
                            <span>è‡ªå‹•ä¿®æ­£å®Ÿè¡Œå›æ•°:</span>
                            <span class="status-value" id="autoCorrectionCount">0ä»¶</span>
                        </div>
                    </div>

                    <!-- æ‰‹å‹•ä¿®æ­£ãƒ‘ã‚¿ãƒ¼ãƒ³è¿½åŠ  -->
                    <div style="margin-bottom: 15px;">
                        <h4>â• ä¿®æ­£ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ‰‹å‹•è¿½åŠ </h4>
                        <div class="correction-input-group">
                            <input type="text" id="originalText" placeholder="éŸ³å£°èªè­˜ã•ã‚Œã‚‹èª¤ã£ãŸæ–‡å­—" autocomplete="off">
                            <input type="text" id="correctedText" placeholder="æ­£ã—ã„æ–‡å­—" autocomplete="off">
                            <button class="btn btn-success" onclick="addLearningData()">è¿½åŠ </button>
                        </div>
                    </div>

                    <!-- å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ç®¡ç† -->
                    <div class="learning-controls">
                        <button class="btn btn-info" onclick="showLearningData()">ğŸ“‹ å­¦ç¿’ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º</button>
                        <button class="btn btn-success" onclick="exportLearningData()">ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                        <button class="btn btn-warning" onclick="importLearningDataDialog()">ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                        <button class="btn btn-danger" onclick="clearLearningData()">ğŸ—‘ï¸ å…¨å‰Šé™¤</button>
                    </div>

                    <!-- å­¦ç¿’ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                    <div id="learningDataDisplay" style="max-height: 200px; overflow-y: auto; margin-top: 15px; display: none;">
                        <!-- å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                    </div>

                    <!-- ãƒ•ã‚¡ã‚¤ãƒ«ã‚¤ãƒ³ãƒãƒ¼ãƒˆç”¨ï¼ˆéè¡¨ç¤ºï¼‰ -->
                    <input type="file" id="learningFileInput" accept=".json,.csv,.txt" style="display: none;" onchange="importLearningData(event)">
                </div>
            </div>
        </div>

        <!-- é€šè©±çµ±è¨ˆï¼ˆå¸¸æ™‚è¡¨ç¤ºï¼‰ -->
        <div class="stats-section">
            <h3>ğŸ“Š é€šè©±çµ±è¨ˆ</h3>
            <div class="status-item">
                <span>é€šè©±æ•°ï¼ˆéŒ²éŸ³é–‹å§‹å›æ•°ï¼‰:</span>
                <span class="status-value" id="callCount">0å›</span>
            </div>
            <div class="status-item">
                <span>ç¾åœ¨ã®é€šè©±æ™‚é–“:</span>
                <span class="status-value" id="currentDuration">00:00</span>
            </div>
            <div class="status-item">
                <span>ç´¯è¨ˆé€šè©±æ™‚é–“:</span>
                <span class="status-value" id="totalDuration">00:00</span>
            </div>
            <div class="status-item">
                <span>å¹³å‡é€šè©±æ™‚é–“:</span>
                <span class="status-value" id="avgDuration">00:00</span>
            </div>
        </div>
    </div>

    <!-- è¦ç´„ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼ˆè¿½åŠ æ©Ÿèƒ½1ï¼šé …ç›®åˆ¥ã‚³ãƒ”ãƒ¼å¯¾å¿œï¼‰ -->
    <div class="summary-popup" id="summaryPopup">
        <div class="summary-header">
            <div class="summary-title" id="summaryPopupTitle">ğŸ¤– å¯¾å¿œè¨˜éŒ²è¦ç´„çµæœ</div>
            <button class="close-btn" onclick="closeSummaryPopup()">Ã—</button>
        </div>
        <div class="summary-content" id="summaryContent">
            è¦ç´„å†…å®¹ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...
        </div>
        <div class="summary-actions">
            <button class="summary-btn copy" onclick="copySummary()">ï¿½ å…¨ä½“ã‚³ãƒ”ãƒ¼</button>
            <button class="summary-btn print" onclick="printSummary()">ğŸ–¨ï¸ å°åˆ·</button>
        </div>
    </div>
    </div>
    
    <script>
        // === ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ===
        let recognition = null;
        let isRecording = false;
        let transcript = '';
        let transcriptHTML = ''; // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ç”¨
        let apiKey = '';
        let isEditMode = false;
        let isAuthenticated = false;
        
        let callCount = 0;
        let currentCallStart = null;
        let currentCallDuration = 0;
        let totalDuration = 0;
        let callTimer = null;
        
        let learningData = {};
        let learningDataRegex = null; // è‡ªå‹•ä¿®æ­£ã‚’é«˜é€ŸåŒ–ã™ã‚‹ãŸã‚ã®æ­£è¦è¡¨ç¾
        let learningDataMap = new Map(); // è‡ªå‹•ä¿®æ­£ã‚’é«˜é€ŸåŒ–ã™ã‚‹ãŸã‚ã®ãƒãƒƒãƒ—
        let sessionCorrectionCount = 0;
        let autoCorrectionCount = 0;
        
        let currentSummary = '';
        let summaryData = {};
        let saveDirectory = null; 
        
        const AUTH_CONFIG = {
            username: 'cbts-sol',
            password: 'cbts1192'
        };
        
        let templates = {};
        
        let currentPrompt = 'default';
        const prompts = {
            default:`ã‚ãªãŸã¯è©¦é¨“æ¥­ç•Œã‚µãƒãƒ¼ãƒˆã‚»ãƒ³ã‚¿ãƒ¼ã®å°‚é–€ã‚¹ã‚¿ãƒƒãƒ•ã§ã™ã€‚ä»¥ä¸‹ã®æ¡ä»¶ã¨å‡ºåŠ›å½¢å¼ã«æ²¿ã£ã¦ã€å¯¾å¿œè¨˜éŒ²ç”¨ã®è¦ç´„ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

### èƒŒæ™¯
ãƒ»å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆã¯è©¦é¨“ãƒ»æ¤œå®šãƒ»è³‡æ ¼ã«é–¢ã™ã‚‹ã‚«ã‚¹ã‚¿ãƒã‚µãƒãƒ¼ãƒˆã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ–‡å­—ãŠè¶Šã—ã®çµæœã§ã™
ãƒ»ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæå‡ºç”¨ã®å¯¾å¿œè¨˜éŒ²ã¨ã—ã¦ä½¿ç”¨ã—ã¾ã™
ãƒ»å¯¾å¿œè€…ã®ç™ºè¨€ã®ã¿ãŒè¨˜éŒ²ã•ã‚Œã¦ãŠã‚Šã€é¡§å®¢ã®ç™ºè¨€ã¯å«ã¾ã‚Œã¦ã„ã¾ã›ã‚“
ãƒ»å•åˆã›å†…å®¹ã¯ã€å¿…ãšå¾©å”±ã—ã¾ã™ã€‚

### æ¡ä»¶
1. èª¤å­—è„±å­—ã€éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼ä¿®æ­£ã€è‡ªç„¶ãªæ—¥æœ¬èªè¡¨ç¾
2. è³ªå•å†…å®¹ã¨å›ç­”å†…å®¹ã®æ˜ç¢ºãªåŒºåˆ†
3. è©¦é¨“ãƒ»æ¤œå®šãƒ»è³‡æ ¼ç‰¹æœ‰ã®ç”¨èªï¼ˆç´šã€å—é¨“ã€è©¦é¨“æ–™ç­‰ï¼‰æ­£ç¢ºãªè¨˜è¼‰
4. é¡§å®¢æƒ…å ±ã€å—é¨“å†…å®¹ã€è³ªå•å†…å®¹ã®æ­£ç¢ºãªæŠ½å‡º
5. å¯¾å¿œæ‰‹é †ã¨æ¡ˆå†…å†…å®¹ã®ç°¡æ½”ãªã¾ã¨ã‚
6. **æœ€é‡è¦: äººç‰©åã¯ã™ã¹ã¦ã‚«ã‚¿ã‚«ãƒŠè¡¨è¨˜ã«çµ±ä¸€ã€‚**
7. è©¦é¨“åï¼ˆæ¤œå®šåï¼‰ã®ã€Œã€‡ç´šã€ã¯çœç•¥ã›ãšã€**æ­£ç¢ºã«è¡¨ç¤º**ã€‚
8. è¦ç´„æ–‡ç« ã¯å®Œçµã§è¨€ã„åˆ‡ã‚Šã€ä½“è¨€æ­¢ã‚ã§è¨˜è¿°ã€‚
9. ã€Œå›ç­”ãƒ»æ¡ˆå†…å†…å®¹ã€ã¨ã€Œå¯¾å¿œçµæœã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€å¯¾è±¡ã¨ãªã‚‹è©¦é¨“ãƒ»æ¤œå®šãƒ»è³‡æ ¼ã®åç§°ï¼ˆä¾‹: æ¼¢å­—æ¤œå®š2ç´šï¼‰ã‚’**å¿…ãšå«ã‚ã‚‹**ã€‚

### å‡ºåŠ›å½¢å¼
## **é¡§å®¢æƒ…å ±**
ï¼ˆãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰æŠ½å‡ºã—ãŸé¡§å®¢ã®å±æ€§ï¼šå—é¨“è€…æœ¬äººã€å›£ä½“æ‹…å½“è€…ã€ä¿è­·è€…ã€ä»£ç†ã€è©¦é¨“ç®¡ï¼‰
## **å•åˆã›ã‚«ãƒ†ã‚´ãƒªãƒ¼**
ï¼ˆè³ªå•å†…å®¹ï¼ˆå¾©å”±å†…å®¹ï¼‰ã«ãã£ã¦ä»¥ä¸‹ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’é¸æŠã€‚
ï¼ƒã‚«ãƒ†ã‚´ãƒªãƒ¼
1.å€‹äººæƒ…å ±ç™»éŒ²/ç¢ºèª/ä¿®æ­£/å‰Šé™¤
2.ç”³è¾¼/æ”¯æ‰•
3.é¡˜æ›¸/ãƒ‘ãƒ³ãƒ•ãƒ¬ãƒƒãƒˆå¸Œæœ›
4.äºˆç´„ç¢ºèª/å¤‰æ›´/ã‚­ãƒ£ãƒ³ã‚»ãƒ«
5.å—é¨“è³‡æ ¼
6.å†å—é¨“
7.å‡ºé¡Œå½¢å¼/è©¦é¨“å†…å®¹
8.å­¦ç¿’æ–¹æ³•/ãƒ†ã‚­ã‚¹ãƒˆ
9.è©¦é¨“æ—¥ç¨‹/ä¼šå ´/ç©ºå¸­ç…§ä¼š
10.è«‹æ±‚æ›¸/é ˜åæ›¸
11.å—é¨“ç¥¨
12.é…åˆ»/æ¬ å¸­/é“æ¡ˆå†…
13.å½“æ—¥ã®æŒã¡ç‰©
14.æœ¬äººç¢ºèªæ›¸é¡ã®ç¢ºèª/æå‡º
15.è©¦é¨“çµæœ/ãƒ¬ãƒãƒ¼ãƒˆ/åˆæ ¼è¨¼æ›¸ãƒ»é€šçŸ¥æ›¸
16.åˆæ ¼åŸºæº–/è§£ç­”/ç–‘ç¾©
17.è©¦é¨“å¾Œã®æ‰‹ç¶šã
18.ãã®ä»–è©¦é¨“åˆ¶åº¦
19.æŠ˜ã‚Šè¿”ã—
20.è¿”ä¿¡ä¸è¦
21.ç½å®³é–¢é€£
22.ã‚·ã‚¹ãƒ†ãƒ é–¢é€£
23.è©¦é¨“å½“æ—¥é‹å–¶ï¼ˆPBTï¼‰
24.ã‚«ãƒ†ã‚´ãƒªå¤–ï¼‰
## **è©¦é¨“ãƒ»æ¤œå®šå†…å®¹**
ï¼ˆå¯¾è±¡è©¦é¨“ãƒ»æ¤œå®šãƒ»è³‡æ ¼åã€‚**ã€‡ç´šã¯å«ã‚ãªã„**ï¼‰

## **è³ªå•ãƒ»å•ã„åˆã‚ã›å†…å®¹**
ï¼ˆå¾©å”±ã—ãŸè³ªå•ã‚’ç°¡æ½”ã«è¦ç´„ã€è¤‡æ•°è³ªå•ã¯â‘ â‘¡ã§ç•ªå·åˆ†ã‘ï¼‰

## **å›ç­”ãƒ»æ¡ˆå†…å†…å®¹**
ï¼ˆè³ªå•ã¸ã®å›ç­”ã¨æ‰‹é †æ¡ˆå†…ã‚’ç°¡æ½”ã«è¦ç´„ã€è¤‡æ•°å›ç­”ã¯â‘ â‘¡ã§ç•ªå·åˆ†ã‘ã€‚å„å›ç­”ã®æœ€å¾Œã¯"ï½ã¨æ¡ˆå†…"ã§çµ±ä¸€ã€‚**å¯¾è±¡è©¦é¨“ãƒ»æ¤œå®šãƒ»è³‡æ ¼ã®åç§°ã‚’å¿…ãšå«ã‚ã‚‹**ï¼‰

## **å¯¾å¿œçµæœ**
ï¼ˆãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰é¡§å®¢ã®æ°åï¼ˆã‚«ã‚¿ã‚«ãƒŠï¼‰ã€å—é¨“ã—ãŸè©¦é¨“åï¼ˆã€‡ç´šã‚‚å«ã‚€ï¼‰ã‚’å¿…ãšæŠ½å‡ºã—ã€æœ€çµ‚çš„ãªå¯¾å¿œå†…å®¹ã¨åˆã‚ã›ã¦ã€Œï¼ˆæ°åï¼‰æ§˜ã¸ï¼ˆè©¦é¨“åï¼‰ã«ã¤ã„ã¦â—‹â—‹ã‚’æ¡ˆå†…æ¸ˆã€ã®å½¢å¼ã§è¨˜è¼‰ï¼‰

## **ç¶™ç¶šå¯¾å¿œãƒ»ç‰¹è¨˜äº‹é …**
ï¼ˆç¶™ç¶šå¯¾å¿œãŒå¿…è¦ãªäº‹é …ã€é‡è¦æƒ…å ±è¨˜è¼‰ï¼‰`,
            
            support: `ã‚ãªãŸã¯ã‚«ã‚¹ã‚¿ãƒãƒ¼ã‚µãƒãƒ¼ãƒˆã‚»ãƒ³ã‚¿ãƒ¼ã®ãƒ—ãƒ­ã§ã™ã€‚ä»¥ä¸‹ã®æ¡ä»¶ã¨å‡ºåŠ›å½¢å¼ã«æ²¿ã£ã¦ã€æœ€å¾Œã«å¼µã‚Šä»˜ã‘ãŸæ–‡ç« ã®ç”Ÿæˆã‚’è¡Œã£ã¦ãã ã•ã„ã€‚

### èƒŒæ™¯
ãƒ»ãƒ‰ãƒ©ãƒ•ãƒˆã¯å—é›»å¯¾å¿œè€…ã®éŸ³å£°ãƒ†ã‚­ã‚¹ãƒˆã®ã¿ã§ã™ã€‚
ãƒ»ãƒ‰ãƒ©ãƒ•ãƒˆã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¸æå‡ºã™ã‚‹ãŸã‚ã®å±¥æ­´ã§ã™ã€‚

# æ¡ä»¶
**ãƒ‰ãƒ©ãƒ•ãƒˆã®æ–‡ç« ã‚’ä»¥ä¸‹ã®6ã¤ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«æ•´ç†ã—ã€è¦ç‚¹ã‚’ç°¡æ½”ã«ã¾ã¨ã‚ã€‚**
1. èª¤å­—è„±å­—ã€ã¦ã«ãŠã¯ä¿®æ­£ã€è‡ªç„¶ãªæ–‡ç« è¡¨ç¾
2. è³ªå•ã¨å›ç­”ã®æ˜ç¢ºãªåŒºåˆ†
3. è³ªå•ã¨å›ç­”ä»¥å¤–ã®å†…å®¹è¦ç´„
4. ä¸»èªã¨è¿°èªã®æ˜ç¢ºåŒ–
5. å‡ºåŠ›å½¢å¼ã¸ã®æ•´ç†
6. **æœ€é‡è¦: äººç‰©åã¯ã™ã¹ã¦ã‚«ã‚¿ã‚«ãƒŠè¡¨è¨˜ã«çµ±ä¸€ã€‚**
7. è©¦é¨“åï¼ˆæ¤œå®šåï¼‰ã®ã€Œã€‡ç´šã€ã¯çœç•¥ã›ãšã€**æ­£ç¢ºã«è¡¨ç¤º**ã€‚
8. è¦ç´„æ–‡ç« ã¯å®Œçµã§è¨€ã„åˆ‡ã‚Šã€ä½“è¨€æ­¢ã‚ã§è¨˜è¿°ã€‚
9. ã€Œå›ç­”å†…å®¹ã€ã¨ã€Œçµè«–ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯ã€å¯¾è±¡ã¨ãªã‚‹è©¦é¨“ãƒ»æ¤œå®šãƒ»è³‡æ ¼ã®åç§°ï¼ˆä¾‹: æ¼¢å­—æ¤œå®š2ç´šï¼‰ã€å—é¨“è€…æ°åï¼ˆã‚«ã‚¿ã‚«ãƒŠï¼‰ã‚’**å¿…ãšå«ã‚ã‚‹**ã€‚

# å‡ºåŠ›å½¢å¼
## **å—é¨“è©¦é¨“ï¼ˆäºˆå®šå«ã‚€ï¼‰** 
ï¼ˆãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰æŠ½å‡ºã€‚ã€‡ç´šã¯å«ã‚ãªã„ï¼‰
## **å—é¨“æ–¹æ³•**
å€‹äºº/å›£ä½“
## **å¯¾å¿œè€…**
å—é¨“è€…/ä¿è­·è€…/ä»£ç†/å›£ä½“æ‹…å½“è€…/è©¦é¨“å®˜

## **è³ªå•å†…å®¹**
ãƒ†ã‚­ã‚¹ãƒˆã‚’åŸºã«å¾©å”±ã—ãŸè³ªå•ã‚’ç°¡æ½”ã«è¦ç´„
ï¼ˆè¤‡æ•°è³ªå•ã¯â‘ â‘¡ã§ç•ªå·åˆ†ã‘ï¼‰

## **å›ç­”å†…å®¹**
**è³ªå•ã¸ã®å›ç­”ã¨æ‰‹é †æ¡ˆå†…ã‚’ç°¡æ½”ã«è¦ç´„**
ï¼ˆè¤‡æ•°å›ç­”ã¯â‘ â‘¡ã§ç•ªå·åˆ†ã‘ã€‚å›ç­”ã®æœ€å¾Œã¯"ï½ã¨æ¡ˆå†…"ã§çµ±ä¸€ã€‚**å¯¾è±¡è©¦é¨“ãƒ»æ¤œå®šãƒ»è³‡æ ¼ã®åç§°ã‚’å¿…ãšå«ã‚ã‚‹**ï¼‰

## **çµè«–**
**ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰é¡§å®¢ã®æ°åï¼ˆã‚«ã‚¿ã‚«ãƒŠï¼‰ã€å—é¨“ã—ãŸè©¦é¨“åï¼ˆã€‡ç´šã‚‚å«ã‚€ï¼‰ã‚’å¿…ãšæŠ½å‡ºã—ã€æœ€çµ‚çš„ãªå¯¾å¿œå†…å®¹ã¨åˆã‚ã›ã¦ã€Œï¼ˆæ°åï¼‰æ§˜ã¸ï¼ˆè©¦é¨“åï¼‰ã«ã¤ã„ã¦â—‹â—‹ã‚’æ¡ˆå†…æ¸ˆã€ã®å½¢å¼ã§ä½“è¨€æ­¢ã‚ã§è¨˜è¼‰ã€‚**

## **ç†ç”±**
**ç°¡æ½”ã«è¦ç´„ã€ä½“è¨€æ­¢ã‚ã§è¨˜è¿°ã€‚**

## **ãƒ—ãƒ­ã‚»ã‚¹**
**ç°¡æ½”ã«è¦ç´„ã€ä½“è¨€æ­¢ã‚ã§è¨˜è¿°ã€‚**`,
            
            custom: ''
        };

        // === ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ===
        function log(message) {
            const time = new Date().toLocaleTimeString();
            const logMessage = `[${time}] ${message}`;
            console.log(logMessage);
            const debugLog = document.getElementById('debugLog');
            if (debugLog) {
                debugLog.innerHTML += logMessage + '<br>';
                debugLog.scrollTop = debugLog.scrollHeight;
            }
        }
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.className = 'notification';
            document.body.appendChild(notification);
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 3000);
        }
        function formatDuration(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        function updateStatus(elementId, text, type) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = text;
                element.className = `status-value ${type}`;
            }
        }
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // === è¦ç´„æ©Ÿèƒ½ã®é …ç›®åˆ¥ã‚³ãƒ”ãƒ¼å¯¾å¿œ ===
        /**
         * @description è¦ç´„ãƒ†ã‚­ã‚¹ãƒˆã‚’è§£æã—ã€è¦‹å‡ºã—ã‚’ã‚­ãƒ¼ã¨ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›ã™ã‚‹
         * @param {string} summary - ## ã‚„ ### ã‚’å«ã‚€ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å½¢å¼ã®è¦ç´„ãƒ†ã‚­ã‚¹ãƒˆ
         * @returns {Object} è¦‹å‡ºã—ã‚’ã‚­ãƒ¼ã€å†…å®¹ã‚’å€¤ã¨ã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
         */
        function parseSummaryData(summary) {
            const data = {};
            // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã®è¦‹å‡ºã—(## or ###)ã‚’è¡Œé ­ã§åŒºåˆ‡ã‚Šã€å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«åˆ†å‰²ã™ã‚‹
            const sections = summary.split(/(?=^##\s|###\s)/m); 
            for (const section of sections) {
                if (section.trim() === '') continue;
                const lines = section.trim().split('\n');
                // æœ€åˆã®è¡Œã‚’è¦‹å‡ºã—ã¨ã—ã¦æŠ½å‡ºã—ã€ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³è¨˜å·ã‚„è£…é£¾ã‚’é™¤å»
                const header = lines.shift().replace(/^[#\s]+/, '').replace(/\*\*/g, '').trim();
                const content = lines.join('\n').trim();
                if (header) {
                    data[header] = content;
                }
            }
            return data;
        }
        
        function formatSummaryWithCopy(summary) {
            let formatted = summary
                .replace(/## (.*?)$/gm, '<h2 data-section="$1" title="ã‚¯ãƒªãƒƒã‚¯ã§ã‚³ãƒ”ãƒ¼">$1</h2>')
                .replace(/### (.*?)$/gm, '<h3 data-section="$1" title="ã‚¯ãƒªãƒƒã‚¯ã§ã‚³ãƒ”ãƒ¼">$1</h3>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');
            return formatted.replace(/<h([23]) data-section="([^"]*)">(.*?)<\/h[23]>(.*?)(?=<h[23]|$)/gs, '<div class="summary-section" data-section="$2"><h$1 data-section="$2">$3</h$1>$4</div>');
        }

        function addCopyEventListeners() {
            document.getElementById('summaryContent').querySelectorAll('[data-section]').forEach(el => {
                el.addEventListener('click', () => copySummarySection(el.getAttribute('data-section')));
            });
        }
        
        /**
         * @description æŒ‡å®šã•ã‚ŒãŸã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å†…å®¹ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã™ã‚‹
         * @param {string} sectionName - ã‚³ãƒ”ãƒ¼ã™ã‚‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è¦‹å‡ºã—å
         */
        function copySummarySection(sectionName) {
            const textToCopy = summaryData[sectionName];
            if (textToCopy === undefined) {
                showNotification(`âŒ ã€Œ${sectionName}ã€ã®å†…å®¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
                return;
            }
            
            const textArea = document.createElement("textarea");
            textArea.value = textToCopy;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showNotification(`âœ… ã€Œ${sectionName}ã€ã®å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ`);
            } catch (err) {
                showNotification('âŒ ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
            document.body.removeChild(textArea);
        }

        // === çµ‚äº†å‡¦ç† ===
        async function endSession() {
            if (isRecording) {
                stopRecording();
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            if (confirm('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ\nãƒ»çµæœã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜\nãƒ»çµ±è¨ˆã‚’ã‚¯ãƒªã‚¢')) {
                try {
                    if (transcript.trim()) await saveTranscriptToLocal();
                    clearTranscript();
                    clearStatistics();
                    closeSummaryPopup();
                    showNotification('âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒçµ‚äº†ã—ã¾ã—ãŸ');
                } catch (error) {
                    showNotification(`âŒ çµ‚äº†å‡¦ç†ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                }
            }
        }
        async function saveTranscriptToLocal() {
            const saveContent = generateSaveContent();
            try {
                if ('showDirectoryPicker' in window) {
                    if (!saveDirectory) saveDirectory = await window.showDirectoryPicker({ mode: 'readwrite' });
                    const fileHandle = await saveDirectory.getFileHandle(`è¨˜éŒ²_${new Date().toISOString().slice(0,10)}.txt`, { create: true });
                    const writable = await fileHandle.createWritable();
                    await writable.write(saveContent);
                    await writable.close();
                } else {
                    downloadTextWithStats();
                }
            } catch (error) {
                if (error.name !== 'AbortError') downloadTextWithStats();
            }
        }
        function generateSaveContent() {
            const avgDuration = callCount > 0 ? Math.floor(totalDuration / callCount) : 0;
            return `æ—¥ä»˜: ${new Date().toLocaleString('ja-JP')}
é€šè©±æ•°: ${callCount}å›
ç´¯è¨ˆæ™‚é–“: ${formatDuration(totalDuration)}
å¹³å‡æ™‚é–“: ${formatDuration(avgDuration)}
--------------------
${transcript}`;
        }
        function downloadTextWithStats() {
            const filename = `è¨˜éŒ²_${new Date().toISOString().slice(0,10)}.txt`;
            const blob = new Blob([generateSaveContent()], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }
        function clearTranscript() {
            transcript = '';
            transcriptHTML = '';
            updateTranscriptDisplay();
            updateUI();
        }
        function clearStatistics() {
            if (callTimer) clearInterval(callTimer);
            callTimer = null;
            callCount = 0;
            currentCallDuration = 0;
            totalDuration = 0;
            currentCallStart = null;
            localStorage.removeItem('call_statistics');
            updateStatistics();
        }

        // === ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç† ===
        function onTemplateSelectChange() {
            const select = document.getElementById('templateSelect');
            const nameInput = document.getElementById('newTemplateName');
            const contentTextarea = document.getElementById('templateContentTextarea');
            const selectedName = select.value;
            if (selectedName && templates[selectedName]) {
                nameInput.value = selectedName;
                contentTextarea.value = templates[selectedName];
            } else {
                nameInput.value = '';
                contentTextarea.value = '';
            }
        }
        function loadTemplates() {
            const saved = localStorage.getItem('saved_templates');
            if (saved) {
                templates = JSON.parse(saved);
                updateTemplateSelect();
            }
        }
        function saveTemplates() {
            localStorage.setItem('saved_templates', JSON.stringify(templates));
        }
        function updateTemplateSelect() {
            const select = document.getElementById('templateSelect');
            select.innerHTML = '<option value="">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠ...</option>';
            Object.keys(templates).forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            });
        }
        function saveTemplate() {
            const name = document.getElementById('newTemplateName').value.trim();
            const content = document.getElementById('templateContentTextarea').value.trim();
            if (!name || !content) { showNotification('åå‰ã¨å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
            templates[name] = content;
            saveTemplates();
            updateTemplateSelect();
            document.getElementById('templateSelect').value = name;
            showNotification(`ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€Œ${name}ã€ã‚’ä¿å­˜ã—ã¾ã—ãŸ`);
        }
        function deleteTemplate() {
            const selectedName = document.getElementById('templateSelect').value;
            if (!selectedName) { showNotification('å‰Šé™¤ã™ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
            if (confirm(`ã€Œ${selectedName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                delete templates[selectedName];
                saveTemplates();
                updateTemplateSelect();
                onTemplateSelectChange();
                showNotification(`ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€Œ${selectedName}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
            }
        }
        function editTemplate() {
            const selectedName = document.getElementById('templateSelect').value;
            if (!selectedName) { showNotification('ç·¨é›†ã™ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
            document.getElementById('templateContentTextarea').focus();
        }
        function loadTemplate() {
            const selectedName = document.getElementById('templateSelect').value;
            if (!selectedName) { showNotification('èª­ã¿è¾¼ã‚€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
            transcript = templates[selectedName];
            transcriptHTML = escapeHtml(transcript).replace(/\n/g, '<br>');
            updateTranscriptDisplay();
            updateUI();
        }
        function importTemplate(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                const name = prompt('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', file.name.replace(/\.[^/.]+$/, ""));
                if (name) {
                    templates[name] = content;
                    saveTemplates();
                    updateTemplateSelect();
                    document.getElementById('templateSelect').value = name;
                    onTemplateSelectChange();
                }
            };
            reader.readAsText(file, 'UTF-8');
        }

        // === ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç®¡ç† ===
        function updatePromptPreview() {
            const select = document.getElementById('promptSelect');
            const preview = document.getElementById('promptPreview');
            const selected = select.value;
            preview.textContent = (selected === 'custom') ? (localStorage.getItem('custom_prompt') || 'ã‚«ã‚¹ã‚¿ãƒ æœªè¨­å®š') : prompts[selected].substring(0, 100) + '...';
            currentPrompt = selected;
            localStorage.setItem('selected_prompt', selected);
        }
        function editPrompt() {
            const select = document.getElementById('promptSelect');
            let currentText = (select.value === 'custom') ? localStorage.getItem('custom_prompt') || '' : prompts[select.value];
            const newPrompt = prompt("ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç·¨é›†:", currentText);
            if (newPrompt !== null) {
                select.value = 'custom';
                localStorage.setItem('custom_prompt', newPrompt);
                updatePromptPreview();
            }
        }

        // === å­¦ç¿’æ©Ÿèƒ½ ===
        /**
         * @description ç™»éŒ²ã•ã‚ŒãŸå­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã€ç½®æ›ç”¨ã®å˜ä¸€ã®æ­£è¦è¡¨ç¾ã¨ãƒãƒƒãƒ—ã‚’ç”Ÿæˆã™ã‚‹ã€‚
         * é•·ã„å˜èªã‹ã‚‰å…ˆã«ãƒãƒƒãƒã™ã‚‹ã‚ˆã†ã«ã‚½ãƒ¼ãƒˆã™ã‚‹ã“ã¨ã§ã€èª¤ãƒãƒƒãƒã‚’é˜²ãã€‚
         */
        function buildLearningDataRegex() {
            learningDataMap.clear();
            if (Object.keys(learningData).length === 0) {
                learningDataRegex = null;
                return;
            }
            const keys = Object.keys(learningData).sort((a, b) => b.length - a.length);
            for (const key of keys) {
                learningDataMap.set(key.toLowerCase(), learningData[key]);
            }
            const regexString = `\\b(${keys.map(escapeRegex).join('|')})\\b`;
            learningDataRegex = new RegExp(regexString, 'gi');
        }

        function loadLearningData() {
            const saved = localStorage.getItem('speech_learning_data');
            if (saved) {
                learningData = JSON.parse(saved);
            } else {
                learningData = { "ä»¶å": "ã”ç”¨ä»¶", "ãŠä¼ºã—ã‚‡ã†ã‹ã„": "ãŠä¼ºã„ã§ãã¾ã™ã§ã—ã‚‡ã†ã‹", "ãŠèãã—ã‚‡ã†ã‹ã„": "ãŠèãã§ãã¾ã™ã§ã—ã‚‡ã†ã‹", "ç¢ºäºº": "ç¢ºèª", "ã”ç¢ºäºº": "ã”ç¢ºèª", "è§£ç­”": "å›ç­”", "ãŠç­”æ¡ˆ": "ãŠå›ç­”", "é–¢ä¿‚": "æ¼¢æ¤œ", "é–¢è¥¿": "æ¼¢æ¤œ", "é–“ç³»": "æ¼¢æ¤œ", "æ¼¢ç³»": "æ¼¢æ¤œ", "é›†ä¸­": "æ‰¿çŸ¥", "ç¿’å¾—": "æ‰¿çŸ¥", "ä¿®å¾—": "æ‰¿çŸ¥", "ç†è§£": "äº†è§£", "åˆ©å®³": "äº†è§£", "å±¥æ­´": "äº†è§£", "æ”¯åº—å": "è©¦é¨“å", "ã—ã¦ã‚“å": "è©¦é¨“å", "æ”¯åº—ã‚ã„": "è©¦é¨“å", "ã—ã¦ã‚“ã‚ã„": "è©¦é¨“å", "æ”¯åº—åãŒ": "è©¦é¨“åãŒ", "ã—ã¦ã‚“åãŒ": "è©¦é¨“åãŒ", "æŒ‡å®šå": "è©¦é¨“å", "ã—ã¦ã„å": "è©¦é¨“å", "å¸‚åº—å": "è©¦é¨“å", "ã—ã¦ã‚“ãª": "è©¦é¨“å", "10ä»¶": "å—é¨“", "ã˜ã‚…ã£ã‘ã‚“": "å—é¨“", "10æ¤œ": "å—é¨“", "åä»¶": "å—é¨“", "ã˜ã‚…ã†ã‘ã‚“": "å—é¨“", "é‡ä»¶": "å—é¨“", "ä½ä»¶": "å—é¨“", "å……ä»¶": "å—é¨“", "10è»’": "å—é¨“", "10åˆ¸": "å—é¨“", "10å·»": "å—é¨“", "åæ¤œ": "å—é¨“", "ååˆ¸": "å—é¨“", "åå·»": "å—é¨“", "è©¦é¨“å®˜": "è©¦é¨“", "è³¢æ˜": "æ¤œå®š", "æ¤œå®šæ„Ÿ": "æ¤œå®š", "å¥åº·": "æ¤œå®š", "è©¦åˆ": "è©¦é¨“", "è³‡æ ¼ã‹ã‚“": "è³‡æ ¼", "è³‡æ ¼é–“": "è³‡æ ¼", "ã—ã‹ãæ„Ÿ": "è³‡æ ¼", "æ¼¢å­—åˆ¸": "æ¼¢å­—æ¤œå®š", "æ¼¢å­—ã‘ã‚“": "æ¼¢å­—æ¤œå®š", "æ¼¢å­—è»’": "æ¼¢å­—æ¤œå®š", "å®Œæ²»æ¤œå®š": "æ¼¢å­—æ¤œå®š", "æ„Ÿã˜æ¤œå®š": "æ¼¢å­—æ¤œå®š", "å—é¨“æ„Ÿ": "å—é¨“", "å—æ¤œé–“": "å—é¨“", "ã˜ã‚…ã‘ã‚“æ„Ÿ": "å—é¨“", "ç”³ã—è¾¼ã¿æ„Ÿ": "ç”³ã—è¾¼ã¿", "ç”³è¾¼æ„Ÿ": "ç”³ã—è¾¼ã¿", "ã‚‚ã†ã—ã“ã¿æ„Ÿ": "ç”³ã—è¾¼ã¿", "å—é¨“æ–™é‡‘": "å—é¨“æ–™", "ã˜ã‚…ã‘ã‚“ã‚Šã‚‡ã†": "å—é¨“æ–™", "æ¤œå®šæ–™é‡‘": "æ¤œå®šæ–™", "ã‘ã‚“ã¦ã„ã‚Šã‚‡ã†": "æ¤œå®šæ–™", "è©¦é¨“æ—¥æ„Ÿ": "è©¦é¨“æ—¥", "ã—ã‘ã‚“æ—¥": "è©¦é¨“æ—¥", "å—é¨“æ—¥æ„Ÿ": "å—é¨“æ—¥", "ã˜ã‚…ã‘ã‚“æ—¥": "å—é¨“æ—¥", "ç”³è¾¼æœŸé–“": "ç”³è¾¼æœŸé–“", "ã‚‚ã†ã—ã“ã¿æœŸé–“": "ç”³è¾¼æœŸé–“", "ç· åˆ‡æ—¥": "ç· åˆ‡", "ã—ã‚ãã‚Š": "ç· åˆ‡", "æœŸé™æ—¥": "æœŸé™", "ãã’ã‚“": "æœŸé™", "ã™ã„ã¾ã›ã‚“": "ã™ã¿ã¾ã›ã‚“", "ã™ã„ã¾ãˆã‚“": "ã™ã¿ã¾ã›ã‚“", "ã™ã¿ã¾ãˆã‚“": "ã™ã¿ã¾ã›ã‚“", "ã„ã£ã‚‰ã—ã‚ƒã‚‹": "ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã›", "ã„ã‚‰ã—ã‚ƒã‚‹": "ã„ã‚‰ã£ã—ã‚ƒã„ã¾ã›", "ã”ã–ã¾ã™": "ã”ã–ã„ã¾ã™", "ã‚‚ã†ã—ã‚ã‘": "ç”³ã—è¨³", "ãŠãã‚Œã„ã‚Š": "æã‚Œå…¥ã‚Š", "ã¨ã„ã‚ã‚ã›": "ãŠå•ã„åˆã‚ã›", "ã‚‚ã‚“ã‚ã‚ã›": "ãŠå•ã„åˆã‚ã›", "æ‰‹ç¶š": "æ‰‹ç¶šã", "ã¦ã¤ã¥ã": "æ‰‹ç¶šã", "ã‹ãã«ã‚“": "ç¢ºèª", "ã‚Œã‚“ã‚‰ã": "é€£çµ¡", "ãŸã‚“ã¨ã†ã—ã‚ƒ": "æ‹…å½“è€…", "ã²ã¨ã¤": "1ã¤", "ãµãŸã¤": "2ã¤", "ã¿ã£ã¤": "3ã¤", "ã‚ˆã£ã¤": "4ã¤", "ã„ã¤ã¤": "5ã¤", "ã‚€ã£ã¤": "6ã¤", "ãªãªã¤": "7ã¤", "ã‚„ã£ã¤": "8ã¤", "ã“ã“ã®ã¤": "9ã¤", "ã¨ãŠ": "10", "å±±ç”°": "ãƒ¤ãƒãƒ€", "ç”°ä¸­": "ã‚¿ãƒŠã‚«", "ä½è—¤": "ã‚µãƒˆã‚¦", "éˆ´æœ¨": "ã‚¹ã‚ºã‚­", "é«˜æ©‹": "ã‚¿ã‚«ãƒã‚·", "æ¸¡è¾º": "ãƒ¯ã‚¿ãƒŠãƒ™", "ä¼Šè—¤": "ã‚¤ãƒˆã‚¦", "ä¸­æ‘": "ãƒŠã‚«ãƒ ãƒ©", "å°æ—": "ã‚³ãƒãƒ¤ã‚·", "åŠ è—¤": "ã‚«ãƒˆã‚¦", "å‰ç”°": "ãƒ¨ã‚·ãƒ€", "å±±æœ¬": "ãƒ¤ãƒãƒ¢ãƒˆ", "äº•ä¸Š": "ã‚¤ãƒã‚¦ã‚¨", "æœ¨æ‘": "ã‚­ãƒ ãƒ©", "æ—": "ãƒãƒ¤ã‚·", "æ–è—¤": "ã‚µã‚¤ãƒˆã‚¦", "å±±å´": "ãƒ¤ãƒã‚¶ã‚­", "æ£®": "ãƒ¢ãƒª", "æ± ç”°": "ã‚¤ã‚±ãƒ€", "æ©‹æœ¬": "ãƒã‚·ãƒ¢ãƒˆ", "é˜¿éƒ¨": "ã‚¢ãƒ™", "çŸ³å·": "ã‚¤ã‚·ã‚«ãƒ¯", "ä¸­å³¶": "ãƒŠã‚«ã‚¸ãƒ", "å°é‡": "ã‚ªãƒ", "å®®æœ¬": "ãƒŸãƒ¤ãƒ¢ãƒˆ", "åŸç”°": "ãƒãƒ©ãƒ€", "å²¡ç”°": "ã‚ªã‚«ãƒ€", "é•·è°·å·": "ãƒã‚»ã‚¬ãƒ¯", "è—¤åŸ": "ãƒ•ã‚¸ãƒ¯ãƒ©", "ç¦ç”°": "ãƒ•ã‚¯ãƒ€", "æ‘ä¸Š": "ãƒ ãƒ©ã‚«ãƒŸ", "è¿‘è—¤": "ã‚³ãƒ³ãƒ‰ã‚¦", "æ¾æœ¬": "ãƒãƒ„ãƒ¢ãƒˆ", "äº•å£": "ã‚¤ã‚°ãƒ", "å†…ç”°": "ã‚¦ãƒãƒ€", "å¤§é‡": "ã‚ªã‚ªãƒ", "èŠåœ°": "ã‚­ã‚¯ãƒ", "é«˜æœ¨": "ã‚¿ã‚«ã‚®", "ä¸Šé‡": "ã‚¦ã‚¨ãƒ", "æ‰å±±": "ã‚¹ã‚®ãƒ¤ãƒ", "å¢—ç”°": "ãƒã‚¹ãƒ€", "ç«¹å†…": "ã‚¿ã‚±ã‚¦ãƒ", "é‡‘å­": "ã‚«ãƒã‚³", "è¥¿æ‘": "ãƒ‹ã‚·ãƒ ãƒ©", "åƒè‘‰": "ãƒãƒ", "ä¸‰æµ¦": "ãƒŸã‚¦ãƒ©", "å‚æœ¬": "ã‚µã‚«ãƒ¢ãƒˆ", "å°å³¶": "ã‚³ã‚¸ãƒ", "é’æœ¨": "ã‚¢ã‚ªã‚­", "æ¾ç”°": "ãƒãƒ„ãƒ€", "ä¸­å·": "ãƒŠã‚«ã‚¬ãƒ¯", "è—¤ç”°": "ãƒ•ã‚¸ã‚¿", "å¾Œè—¤": "ã‚´ãƒˆã‚¦", "çŸ³ç”°": "ã‚¤ã‚·ãƒ€", "æ‘ç”°": "ãƒ ãƒ©ã‚¿", "å°å·": "ã‚ªã‚¬ãƒ¯", "å²¡æœ¬": "ã‚ªã‚«ãƒ¢ãƒˆ", "æ²³é‡": "ã‚³ã‚¦ãƒ", "ä½ã€…æœ¨": "ã‚µã‚µã‚­", "æŸ´ç”°": "ã‚·ãƒã‚¿", "æ­¦ç”°": "ã‚¿ã‚±ãƒ€", "ä¸Šç”°": "ã‚¦ã‚¨ãƒ€", "è¥¿ç”°": "ãƒ‹ã‚·ãƒ€", "èŠæ± ": "ã‚­ã‚¯ãƒ", "è…åŸ": "ã‚¹ã‚¬ãƒ¯ãƒ©", "é‡å£": "ãƒã‚°ãƒ", "ä¸¸å±±": "ãƒãƒ«ãƒ¤ãƒ", "å¹³é‡": "ãƒ’ãƒ©ãƒ", "å¤§å¡š": "ã‚ªã‚ªãƒ„ã‚«", "æ‰æœ¬": "ã‚¹ã‚®ãƒ¢ãƒˆ", "å‰å·": "ãƒ¨ã‚·ã‚«ãƒ¯", "å®®å´": "ãƒŸãƒ¤ã‚¶ã‚­", "åŸ": "ãƒãƒ©", "æ¨ªå±±": "ãƒ¨ã‚³ãƒ¤ãƒ", "ä¸­é‡": "ãƒŠã‚«ãƒ", "å°é‡å¯º": "ã‚ªãƒãƒ‡ãƒ©", "æ¾å°¾": "ãƒãƒ„ã‚ª", "çŸ³äº•": "ã‚¤ã‚·ã‚¤", "å¤§æ©‹": "ã‚ªã‚ªãƒã‚·", "é«˜ç”°": "ã‚¿ã‚«ãƒ€", "å°å®®": "ã‚³ãƒŸãƒ¤", "é£¯ç”°": "ã‚¤ã‚¤ãƒ€", "æ¸¡éƒ¨": "ãƒ¯ã‚¿ãƒŠãƒ™", "ä»Šäº•": "ã‚¤ãƒã‚¤", "å·ä¸Š": "ã‚«ãƒ¯ã‚«ãƒŸ", "ä¹…ä¿": "ã‚¯ãƒœ", "ä½é‡": "ã‚µãƒ", "æ¸…æ°´": "ã‚·ãƒŸã‚º", "é«˜å±±": "ã‚¿ã‚«ãƒ¤ãƒ", "è°·å£": "ã‚¿ãƒ‹ã‚°ãƒ", "ä¸­è°·": "ãƒŠã‚«ã‚¿ãƒ‹", "è¥¿å±±": "ãƒ‹ã‚·ãƒ¤ãƒ", "é‡æ‘": "ãƒãƒ ãƒ©", "æµœç”°": "ãƒãƒãƒ€", "å¹³ç”°": "ãƒ’ãƒ©ã‚¿", "æ˜Ÿé‡": "ãƒ›ã‚·ãƒ", "å €": "ãƒ›ãƒª", "å‰ç”°": "ãƒã‚¨ãƒ€", "æ¾æ‘": "ãƒãƒ„ãƒ ãƒ©", "ä¸‰å®…": "ãƒŸãƒ¤ã‚±", "æ£®ç”°": "ãƒ¢ãƒªã‚¿", "å±±å£": "ãƒ¤ãƒã‚°ãƒ", "å±±ä¸‹": "ãƒ¤ãƒã‚·ã‚¿", "å±±ä¸­": "ãƒ¤ãƒãƒŠã‚«", "æ¨ªç”°": "ãƒ¨ã‚³ã‚¿", "å‰æ‘": "ãƒ¨ã‚·ãƒ ãƒ©", "è‹¥æ—": "ãƒ¯ã‚«ãƒãƒ¤ã‚·" };
                saveLearningData();
            }
            updateLearningStats();
            buildLearningDataRegex();
        }
        function saveLearningData() { localStorage.setItem('speech_learning_data', JSON.stringify(learningData)); }
        function updateLearningStats() {
            document.getElementById('learningCount').textContent = `${Object.keys(learningData).length}ä»¶`;
            document.getElementById('sessionCorrectionCount').textContent = `${sessionCorrectionCount}ä»¶`;
            document.getElementById('autoCorrectionCount').textContent = `${autoCorrectionCount}ä»¶`;
        }
        function addLearningData() {
            const original = document.getElementById('originalText').value.trim();
            const corrected = document.getElementById('correctedText').value.trim();
            if (!original || !corrected) { showNotification('âŒ ä¸¡æ–¹ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
            if (original === corrected) { showNotification('âŒ ä¿®æ­£å‰ã¨ä¿®æ­£å¾ŒãŒåŒã˜ã§ã™'); return; }
            if (learningData[original] && !confirm(`ã€Œ${original}ã€ã¯æ—¢ã«å­¦ç¿’æ¸ˆã¿ã§ã™ã€‚ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ`)) return;
            learningData[original] = corrected;
            saveLearningData();
            buildLearningDataRegex();
            updateLearningStats();
            document.getElementById('originalText').value = '';
            document.getElementById('correctedText').value = '';
            if (document.getElementById('learningDataDisplay').style.display !== 'none') showLearningData();
            showNotification(`âœ… å­¦ç¿’ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¿½åŠ : ${original} â†’ ${corrected}`);
        }
        function showLearningData() {
            const display = document.getElementById('learningDataDisplay');
            if (Object.keys(learningData).length === 0) {
                display.innerHTML = '<p style="text-align: center; color: #666;">å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
            } else {
                display.innerHTML = Object.entries(learningData).map(([original, corrected]) => `
                        <div class="learning-item">
                            <div class="correction-text">
                                <span class="original">"${escapeHtml(original)}"</span> â†’ <span class="corrected">"${escapeHtml(corrected)}"</span>
                            </div>
                            <div class="actions">
                                <button class="btn btn-danger btn-small" onclick="deleteLearningData('${escapeHtml(original)}')">å‰Šé™¤</button>
                            </div>
                        </div>`).join('');
            }
            display.style.display = 'block';
        }
        function deleteLearningData(original) {
            if (confirm(`å­¦ç¿’ãƒ‘ã‚¿ãƒ¼ãƒ³ã€Œ${original}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                delete learningData[original];
                saveLearningData();
                buildLearningDataRegex();
                updateLearningStats();
                showLearningData();
                showNotification(`ğŸ—‘ï¸ å­¦ç¿’ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å‰Šé™¤: ${original}`);
            }
        }
        function exportLearningData() {
            if (Object.keys(learningData).length === 0) { showNotification('âŒ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            const filename = `è©¦é¨“æ¥­ç•ŒéŸ³å£°èªè­˜å­¦ç¿’ãƒ‡ãƒ¼ã‚¿_${timestamp}.json`;
            const exportData = {
                learningData: learningData,
                statistics: { sessionCorrections: sessionCorrectionCount, autoCorrections: autoCorrectionCount }
            };
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification(`ğŸ“¤ å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`);
        }
        function importLearningDataDialog() { document.getElementById('learningFileInput').click(); }
        function importLearningData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    const importedData = data.learningData || data;
                    if (Object.keys(importedData).length === 0) { showNotification('âŒ ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¯èƒ½ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ'); return; }
                    if (confirm(`${Object.keys(importedData).length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã‹ï¼Ÿ`)) {
                        Object.assign(learningData, importedData);
                        saveLearningData();
                        buildLearningDataRegex();
                        updateLearningStats();
                        showNotification(`ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†`);
                    }
                } catch (error) {
                    showNotification(`âŒ ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
                }
            };
            reader.readAsText(file, 'UTF-8');
            event.target.value = '';
        }
        function clearLearningData() {
            if (confirm(`å…¨ã¦ã®å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ï¼ˆ${Object.keys(learningData).length}ä»¶ï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                learningData = {};
                saveLearningData();
                buildLearningDataRegex();
                updateLearningStats();
                showLearningData();
                showNotification('ğŸ—‘ï¸ å…¨ã¦ã®å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            }
        }
        function quickLearn() {
            if (!transcript.trim()) { showNotification('âŒ å­¦ç¿’å¯¾è±¡ã¨ãªã‚‹ãƒ†ã‚­ã‚¹ãƒˆãŒã‚ã‚Šã¾ã›ã‚“'); return; }
            const lastLine = transcript.trim().split('\n').pop();
            if (!lastLine) { showNotification('âŒ æœ€æ–°ã®èªè­˜ãƒ†ã‚­ã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }
            const correctedText = prompt(`ğŸ§  ã‚¯ã‚¤ãƒƒã‚¯å­¦ç¿’\n\næœ€æ–°ã®èªè­˜ãƒ†ã‚­ã‚¹ãƒˆ:\n"${lastLine}"\n\næ­£ã—ã„ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:`);
            if (correctedText && correctedText.trim() && correctedText.trim() !== lastLine) {
                learningData[lastLine] = correctedText.trim();
                saveLearningData();
                buildLearningDataRegex();
                transcript = transcript.replace(new RegExp(escapeRegex(lastLine) + '$'), correctedText.trim());
                transcriptHTML = escapeHtml(transcript).replace(/\n/g, '<br>');
                updateTranscriptDisplay();
                updateLearningStats();
                showNotification(`ğŸ§  ã‚¯ã‚¤ãƒƒã‚¯å­¦ç¿’å®Œäº†`);
            }
        }
        
        /**
         * @description äº‹å‰ã«ç”Ÿæˆã—ãŸæ­£è¦è¡¨ç¾ã¨ãƒãƒƒãƒ—ã‚’ä½¿ã„ã€ãƒ†ã‚­ã‚¹ãƒˆå†…ã®å˜èªã‚’é«˜é€Ÿã«è‡ªå‹•ä¿®æ­£ã™ã‚‹
         * @param {string} text - ä¿®æ­£å¯¾è±¡ã®ãƒ†ã‚­ã‚¹ãƒˆ
         * @returns {string} ä¿®æ­£å¾Œã®ãƒ†ã‚­ã‚¹ãƒˆ
         */
        function applyAutoCorrections(text) {
            if (!document.getElementById('autoCorrection').checked || !learningDataRegex) {
                return text;
            }
            
            let correctionsMade = 0;
            const correctedText = text.replace(learningDataRegex, (match) => {
                const replacement = learningDataMap.get(match.toLowerCase());
                if (replacement) {
                    correctionsMade++;
                    return replacement;
                }
                return match;
            });

            if (correctionsMade > 0) {
                autoCorrectionCount += correctionsMade;
                updateLearningStats();
            }
            return correctedText;
        }

        // === æŠ˜ã‚ŠãŸãŸã¿åˆ¶å¾¡ ===
        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId.replace('Section', 'Content'));
            const arrow = document.getElementById(sectionId.replace('Section', 'Arrow'));
            if (content && arrow) {
                content.classList.toggle('collapsed');
                content.classList.toggle('expanded');
                arrow.textContent = content.classList.contains('expanded') ? 'â–²' : 'â–¼';
            }
        }

        // === èªè¨¼æ©Ÿèƒ½ ===
        function initAuthentication() {
            const authForm = document.getElementById('authForm');
            authForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                if (username === AUTH_CONFIG.username && password === AUTH_CONFIG.password) {
                    localStorage.setItem('speech_auth', JSON.stringify({ authenticated: true, timestamp: Date.now() }));
                    showMainContent();
                } else {
                    const authError = document.getElementById('authError');
                    authError.textContent = 'âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™';
                    authError.style.display = 'block';
                    setTimeout(() => { authError.style.display = 'none'; }, 3000);
                }
            });
            const savedAuth = localStorage.getItem('speech_auth');
            if (savedAuth && (Date.now() - JSON.parse(savedAuth).timestamp < 24 * 60 * 60 * 1000)) {
                showMainContent();
            }
        }
        function showMainContent() {
            document.getElementById('authOverlay').style.display = 'none';
            document.getElementById('mainContent').classList.add('authenticated');
            initializeMainFeatures();
        }

        // === çµ±è¨ˆç®¡ç† ===
        function loadStatistics() {
            const saved = localStorage.getItem('call_statistics');
            if (saved) {
                const stats = JSON.parse(saved);
                callCount = stats.callCount || 0;
                totalDuration = stats.totalDuration || 0;
            }
            updateStatistics();
        }
        function saveStatistics() {
            localStorage.setItem('call_statistics', JSON.stringify({ callCount, totalDuration }));
        }
        function updateStatistics() {
            document.getElementById('callCount').textContent = `${callCount}å›`;
            document.getElementById('currentDuration').textContent = formatDuration(currentCallDuration);
            document.getElementById('totalDuration').textContent = formatDuration(totalDuration);
            const avgDuration = callCount > 0 ? Math.floor(totalDuration / callCount) : 0;
            document.getElementById('avgDuration').textContent = formatDuration(avgDuration);
        }
        function startCallTimer() {
            currentCallStart = Date.now();
            callTimer = setInterval(() => {
                currentCallDuration = Math.floor((Date.now() - currentCallStart) / 1000);
                updateStatistics();
            }, 1000);
        }
        function stopCallTimer() {
            clearInterval(callTimer);
            if (currentCallStart) {
                totalDuration += Math.floor((Date.now() - currentCallStart) / 1000);
                currentCallDuration = 0;
                currentCallStart = null;
                saveStatistics();
                updateStatistics();
            }
        }

        // === ç’°å¢ƒãƒã‚§ãƒƒã‚¯ãƒ»éŸ³å£°èªè­˜ ===
        function checkEnvironment() {
            const isHTTPS = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
            updateStatus('httpsStatus', isHTTPS ? 'âœ… OK' : 'âŒ NG', isHTTPS ? 'success' : 'error');
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const isSupported = SpeechRecognition && isHTTPS;
            updateStatus('speechStatus', isSupported ? 'âœ… OK' : 'âŒ NG', isSupported ? 'success' : 'error');
            return isSupported;
        }
        function initSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) return false;
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'ja-JP';
            recognition.onstart = () => {
                isRecording = true;
                callCount++;
                startCallTimer();
                updateUI();
                document.getElementById('transcriptArea').classList.add('listening');
            };
            
            recognition.onresult = (event) => {
                try {
                    let interim_transcript = '';
                    let final_transcript_chunk = '';
                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        const chunk = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            final_transcript_chunk += chunk;
                        } else {
                            interim_transcript += chunk;
                        }
                    }

                    if (final_transcript_chunk) {
                        const corrected_chunk = applyAutoCorrections(final_transcript_chunk);
                        transcript += corrected_chunk + '\n';
                        transcriptHTML += escapeHtml(corrected_chunk + '\n').replace(/\n/g, '<br>');
                        log(`ğŸ“ ç¢ºå®šãƒ†ã‚­ã‚¹ãƒˆ: ${corrected_chunk}`);
                    }
                    updateTranscriptDisplay(interim_transcript);
                } catch (error) {
                    log(`éŸ³å£°èªè­˜çµæœå‡¦ç†ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                }
            };

            recognition.onerror = (event) => {
                log(`âŒ éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼: ${event.error}`);
                if (event.error === 'not-allowed') {
                    updateStatus('micStatus', 'âŒ æ‹’å¦', 'error');
                    stopRecording();
                }
            };

            recognition.onend = () => {
                if (!isRecording) {
                    log('ğŸ¤ éŒ²éŸ³ã¯åœæ­¢ã•ã‚Œã¾ã—ãŸã€‚');
                    document.getElementById('transcriptArea').classList.remove('listening');
                    return;
                }

                log('ğŸ¤ èªè­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒä¸€æ—¦çµ‚äº†ã—ã¾ã—ãŸã€‚è‡ªå‹•ã§å†é–‹ã—ã¾ã™...');
                // å®‰å®šæ€§å‘ä¸Šã®ãŸã‚ã€requestAnimationFrameã‚’ä½¿ç”¨ã—ã¦å†é–‹
                requestAnimationFrame(() => {
                    if (isRecording) {
                        try {
                            recognition.start();
                        } catch (e) {
                            log(`âŒ èªè­˜ã®è‡ªå‹•å†é–‹ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.message}`);
                            stopRecording(); 
                        }
                    }
                });
            };
            return true;
        }

        // === UIåˆ¶å¾¡ ===
        function updateUI() {
            const summaryBtn = document.getElementById('summaryBtn');
            const hasText = isEditMode ? document.getElementById('transcriptTextarea').value.trim() : transcript.trim();

            document.getElementById('startBtn').disabled = isRecording;
            document.getElementById('stopBtn').disabled = !isRecording;
            document.getElementById('downloadBtn').disabled = !transcript.trim();
            if (summaryBtn) summaryBtn.disabled = !hasText || !apiKey;
            document.getElementById('endBtn').disabled = isRecording;
            document.getElementById('quickLearnBtn').disabled = !transcript.trim() || isRecording;
            const editToggleBtn = document.getElementById('editToggleBtn');
            editToggleBtn.textContent = isEditMode ? 'ğŸ‘ï¸ è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰' : 'âœï¸ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰';
            editToggleBtn.style.background = isEditMode ? '#dc3545' : '#17a2b8';
        }
        function toggleEditMode() {
            isEditMode = !isEditMode;
            const area = document.getElementById('transcriptArea');
            const textarea = document.getElementById('transcriptTextarea');
            if (isEditMode) {
                textarea.value = transcript;
                area.style.display = 'none';
                textarea.style.display = 'block';
            } else {
                transcript = textarea.value;
                transcriptHTML = escapeHtml(transcript).replace(/\n/g, '<br>');
                updateTranscriptDisplay();
                area.style.display = 'block';
                textarea.style.display = 'none';
            }
            updateUI();
        }
        function updateTranscriptDisplay(interimText = '') {
            const area = document.getElementById('transcriptArea');
            const interimHTML = interimText ? `<span style="color:#999;">${escapeHtml(interimText)}</span>` : '';
            if (!transcript.trim() && !interimText.trim()) {
                area.classList.add('empty');
                area.innerHTML = 'éŸ³å£°èªè­˜çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...';
            } else {
                area.classList.remove('empty');
                area.innerHTML = transcriptHTML + interimHTML;
            }
            area.scrollTop = area.scrollHeight;
        }

        // === éŒ²éŸ³åˆ¶å¾¡ ===
        function startRecording() {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    stream.getTracks().forEach(track => track.stop());
                    updateStatus('micStatus', 'âœ… è¨±å¯', 'success');
                    const timestamp = `\n[${new Date().toLocaleTimeString()}]\n`;
                    transcript += timestamp;
                    transcriptHTML += `<br>[${new Date().toLocaleTimeString()}]<br>`;
                    updateTranscriptDisplay();
                    recognition.start();
                })
                .catch(err => {
                    updateStatus('micStatus', 'âŒ æ‹’å¦', 'error');
                    showNotification('âŒ ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ãŒå¿…è¦ã§ã™');
                });
        }
        function stopRecording() {
            isRecording = false;
            if (recognition) {
                recognition.stop();
            }
            stopCallTimer();
            updateUI();
        }

        // === ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œ ===
        function downloadText() {
            if (!transcript.trim()) { showNotification('âŒ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆãŒã‚ã‚Šã¾ã›ã‚“'); return; }
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            const filename = `è©¦é¨“æ¥­ç•Œã‚µãƒãƒ¼ãƒˆå¯¾å¿œè¨˜éŒ²_${timestamp}.txt`;
            const blob = new Blob([transcript], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // === APIé–¢é€£ ===
        function setupAPI() {
            const key = prompt('Gemini APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', apiKey);
            if (key && key.trim().startsWith('AIzaSy')) {
                apiKey = key.trim();
                localStorage.setItem('gemini_api_key', apiKey);
                updateStatus('apiStatus', 'âœ… è¨­å®šæ¸ˆ', 'success');
                document.getElementById('testBtn').disabled = false;
                updateUI();
                showNotification('âœ… APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¾ã—ãŸ');
            } else if (key !== null) {
                showNotification('âŒ ç„¡åŠ¹ãªAPIã‚­ãƒ¼å½¢å¼ã§ã™');
            }
        }
        async function testAPI() {
            if (!apiKey) { showNotification('âŒ APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“'); return; }
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: "Hello" }] }] })
                });
                if (response.ok) {
                    showNotification('âœ… APIæ¥ç¶šæˆåŠŸï¼');
                } else {
                    showNotification(`âŒ APIæ¥ç¶šå¤±æ•—: ${response.status}`);
                }
            } catch (error) {
                showNotification(`âŒ APIæ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        // === è¦ç´„å®Ÿè¡Œ (ã‚·ãƒ³ã‚°ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆç‰ˆ) ===
        async function generateSummary() {
            log('ğŸ¤– è¦ç´„é–‹å§‹ (ã‚·ãƒ³ã‚°ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ)');
            if (!apiKey) { showNotification('âŒ APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“'); return; }

            const textSource = isEditMode ? document.getElementById('transcriptTextarea').value : transcript;
            const lines = textSource.split('\n');
            let lastTimestampIndex = -1;
            for (let i = lines.length - 1; i >= 0; i--) {
                if (/^\[\d{1,2}:\d{2}:\d{2}\]$/.test(lines[i].trim())) {
                    lastTimestampIndex = i;
                    break;
                }
            }
            const textToSummarize = (lastTimestampIndex !== -1 ? lines.slice(lastTimestampIndex).join('\n') : textSource).trim();
            
            if (!textToSummarize) {
                showNotification('âŒ è¦ç´„ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            log(`ğŸ“ è¦ç´„å¯¾è±¡ãƒ†ã‚­ã‚¹ãƒˆï¼ˆ${textToSummarize.length}æ–‡å­—ï¼‰ã‚’ç‰¹å®šã—ã¾ã—ãŸã€‚`);

            const summaryBtn = document.getElementById('summaryBtn');
            summaryBtn.textContent = 'ğŸ¤– è¦ç´„ä¸­...';
            summaryBtn.disabled = true;
            
            const summaryPopup = document.getElementById('summaryPopup');
            const summaryContent = document.getElementById('summaryContent');
            const summaryPopupTitle = document.getElementById('summaryPopupTitle');
            summaryPopupTitle.textContent = 'ğŸ¤– è¦ç´„ç”Ÿæˆä¸­...';
            summaryContent.innerHTML = '<div style="padding:20px; text-align:center;">è¦ç´„ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™...</div>';
            summaryPopup.style.display = 'block';

            try {
                let basePrompt = (currentPrompt === 'custom') ? localStorage.getItem('custom_prompt') || prompts.default : prompts[currentPrompt];
                const fullPrompt = `${basePrompt}\n\nä»¥ä¸‹ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’è¦ç´„ã—ã¦ãã ã•ã„:\n\n---\n${textToSummarize}`;

                let finalSummary = '';
                const MAX_RETRIES = 3;
                for (let attempt = 1; attempt <= MAX_RETRIES; attempt++) {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: fullPrompt }] }] })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        finalSummary = data?.candidates?.[0]?.content?.parts?.[0]?.text || "è¦ç´„ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
                        break; // æˆåŠŸã—ãŸã®ã§ãƒ«ãƒ¼ãƒ—ã‚’æŠœã‘ã‚‹
                    } else if (response.status === 503 && attempt < MAX_RETRIES) {
                        log(`âš ï¸ API 503ã‚¨ãƒ©ãƒ¼ã€‚${attempt * 2}ç§’å¾Œã«å†è©¦è¡Œã—ã¾ã™... (${attempt}/${MAX_RETRIES})`);
                        summaryContent.innerHTML = `<div style="padding:20px; text-align:center;">ã‚µãƒ¼ãƒãƒ¼ãŒæ··ã¿åˆã£ã¦ã„ã¾ã™ã€‚<br>å†è©¦è¡Œä¸­ (${attempt}/${MAX_RETRIES})...</div>`;
                        await new Promise(resolve => setTimeout(resolve, 2000 * attempt));
                    } else {
                        throw new Error(`APIã‚¨ãƒ©ãƒ¼: ${response.status}`);
                    }
                }
                
                if (finalSummary) {
                    summaryPopupTitle.textContent = 'ğŸ¤– å¯¾å¿œè¨˜éŒ²è¦ç´„çµæœ';
                    showSummaryPopup(finalSummary);
                } else {
                    throw new Error("APIã‹ã‚‰ã®å¿œç­”ãŒç©ºã‹ã€å…¨ã¦ã®ãƒªãƒˆãƒ©ã‚¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
                }

            } catch (error) {
                log(`âŒ è¦ç´„ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                let errorMessage = `è¦ç´„ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br><small>${error.message}</small>`;
                if (error.message.includes('503')) {
                    errorMessage = `è¦ç´„ã‚µãƒ¼ãƒãƒ¼ãŒä¸€æ™‚çš„ã«åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚<br><small>ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚(ã‚¨ãƒ©ãƒ¼: 503)</small>`;
                }
                showNotification(`âŒ è¦ç´„ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                summaryContent.innerHTML = `<div style="padding:20px; text-align:center; color:red;">${errorMessage}</div>`;
            } finally {
                summaryBtn.textContent = 'ğŸ¤– å¯¾å¿œè¨˜éŒ²è¦ç´„';
                updateUI();
            }
        }
        
        function showSummaryPopup(summary) {
            const summaryPopup = document.getElementById('summaryPopup');
            const summaryContent = document.getElementById('summaryContent');
            currentSummary = summary;
            summaryData = parseSummaryData(summary);
            summaryContent.innerHTML = formatSummaryWithCopy(summary);
            summaryPopup.style.display = 'block';
            addCopyEventListeners();
        }

        function closeSummaryPopup() {
            document.getElementById('summaryPopup').style.display = 'none';
        }

        function copySummary() {
            if (currentSummary) {
                const textArea = document.createElement("textarea");
                textArea.value = currentSummary;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showNotification('âœ… è¦ç´„ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
                } catch (err) {
                    showNotification('âŒ ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                document.body.removeChild(textArea);
            }
        }

        function printSummary() {
            if (currentSummary) {
                const printWindow = window.open('', 'Print');
                printWindow.document.write(`<html><head><title>è¦ç´„</title></head><body>${currentSummary.replace(/\n/g, '<br>')}</body></html>`);
                printWindow.document.close();
                printWindow.print();
            }
        }
        
        // === ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š ===
        function setupEvents() {
            document.getElementById('startBtn').onclick = startRecording;
            document.getElementById('stopBtn').onclick = stopRecording;
            document.getElementById('downloadBtn').onclick = downloadText;
            document.getElementById('apiBtn').onclick = setupAPI;
            document.getElementById('testBtn').onclick = testAPI;
            document.getElementById('summaryBtn').onclick = generateSummary;
            document.getElementById('endBtn').onclick = endSession;
            document.getElementById('quickLearnBtn').onclick = quickLearn;
            document.getElementById('promptSelect').onchange = updatePromptPreview;
            document.addEventListener('keydown', (event) => {
                if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') return;
                if (event.code === 'Space' && event.target === document.body) {
                    event.preventDefault();
                    isRecording ? stopRecording() : startRecording();
                }
                if (event.key === 'Escape') {
                    const summaryPopup = document.getElementById('summaryPopup');
                    if (summaryPopup && summaryPopup.style.display === 'block') {
                        closeSummaryPopup();
                    }
                }
            });
        }

        // === åˆæœŸåŒ– ===
        function initialize() {
            initAuthentication();
        }
        function initializeMainFeatures() {
            const savedKey = localStorage.getItem('gemini_api_key');
            if (savedKey) {
                apiKey = savedKey;
                updateStatus('apiStatus', 'âœ… è¨­å®šæ¸ˆ', 'success');
                document.getElementById('testBtn').disabled = false;
            }
            const savedPrompt = localStorage.getItem('selected_prompt');
            if (savedPrompt) {
                document.getElementById('promptSelect').value = savedPrompt;
                updatePromptPreview();
            }
            loadTemplates();
            loadLearningData();
            loadStatistics();
            if (checkEnvironment()) {
                initSpeechRecognition();
            }
            setupEvents();
            updateUI();
            toggleSection('statusSection');
            log('âœ… ãƒ¡ã‚¤ãƒ³æ©Ÿèƒ½åˆæœŸåŒ–å®Œäº†');
        }

        // DOMèª­ã¿è¾¼ã¿å®Œäº†å¾Œã«åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
